name: Docker Build & Deploy

on:
  push:
    branches: [main]
    paths:
      - 'ai_server/**'
      - '.github/workflows/docker-deploy.yml'

# ì¤‘ë³µ ë°°í¬ ë°©ì§€ (í•œ ë²ˆì— í•˜ë‚˜ë§Œ ì‹¤í–‰)
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  test:
    name: ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ai_server
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Python 3.11 ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Poetry ìºì‹±
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pypoetry
            ai_server/.venv
          key: ${{ runner.os }}-poetry-${{ hashFiles('ai_server/poetry.lock') }}
      
      - name: Poetry ì„¤ì¹˜
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          poetry install --no-interaction --no-ansi
      
      - name: Linting (ruff)
        run: |
          poetry run ruff check app/
      
      - name: ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          poetry run pytest tests/unit/ -v --tb=short
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LANGCHAIN_API_KEY: ${{ secrets.LANGCHAIN_API_KEY }}
          LANGCHAIN_PROJECT: onsikgu-ai-test

  build-and-deploy:
    name: Docker ë¹Œë“œ & EC2 ë°°í¬
    needs: test  # í…ŒìŠ¤íŠ¸ ì„±ê³µ ì‹œì—ë§Œ ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        working-directory: ai_server
        run: |
          docker build -t onsikgu-ai-server:${{ github.sha }} .
          docker tag onsikgu-ai-server:${{ github.sha }} onsikgu-ai-server:latest
      
      - name: Docker ì´ë¯¸ì§€ ì €ì¥ (tar)
        run: |
          docker save onsikgu-ai-server:latest | gzip > onsikgu-ai-server.tar.gz
      
      - name: EC2ë¡œ ì´ë¯¸ì§€ ì „ì†¡ & ë°°í¬
        uses: appleboy/ssh-action@master
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LANGCHAIN_API_KEY: ${{ secrets.LANGCHAIN_API_KEY }}
          LANGCHAIN_PROJECT: ${{ secrets.LANGCHAIN_PROJECT }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 10m
          envs: OPENAI_API_KEY,LANGCHAIN_API_KEY,LANGCHAIN_PROJECT
          script: |
            #!/bin/bash
            set -e
            
            echo "=========================================="
            echo "ğŸ³ Docker ë°°í¬ ì‹œì‘"
            echo "ì‹œê°„: $(date)"
            echo "=========================================="
            
            # 1. ì‘ì—… ë””ë ‰í† ë¦¬
            cd ~
            mkdir -p onsikgu_ai/ai_server
            cd onsikgu_ai/ai_server
            
            # 2. ë°ì´í„° ë””ë ‰í† ë¦¬ í™•ì¸
            echo "ğŸ“‚ ë°ì´í„° ë””ë ‰í† ë¦¬ í™•ì¸ ì¤‘..."
            mkdir -p ~/onsikgu_data/chroma
            echo "   âœ… ë°ì´í„° ê²½ë¡œ: ~/onsikgu_data/chroma"
            
            # 3. .env íŒŒì¼ ìƒì„±
            echo "ğŸ“ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¤‘..."
            cat > .env << EOF
            # OpenAI API
            OPENAI_API_KEY=${OPENAI_API_KEY}
            
            # Langsmith
            LANGCHAIN_TRACING_V2=true
            LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
            LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT}
            
            # ChromaDB
            CHROMA_PERSIST_DIRECTORY=/data/chroma
            CHROMA_COLLECTION_NAME=qa_history
            CHROMA_DATA_PATH=${HOME}/onsikgu_data/chroma
            
            # Server
            ENVIRONMENT=production
            EOF
            echo "   âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ"
            
            # 4. docker-compose.yml ë‹¤ìš´ë¡œë“œ
            echo "ğŸ“¥ docker-compose.yml ë‹¤ìš´ë¡œë“œ ì¤‘..."
            curl -sSL https://raw.githubusercontent.com/${{ github.repository }}/main/ai_server/docker-compose.yml -o docker-compose.yml
            
            # 5. Docker ì„¤ì¹˜ í™•ì¸
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Docker ì„¤ì¹˜ ì¤‘..."
              curl -fsSL https://get.docker.com | sh
              sudo usermod -aG docker ubuntu
              newgrp docker
            fi
            
            # 6. Docker Compose ì„¤ì¹˜ í™•ì¸
            if ! command -v docker-compose &> /dev/null; then
              echo "ğŸ³ Docker Compose ì„¤ì¹˜ ì¤‘..."
              sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi
            
            # 7. ì´ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì •ë¦¬
            echo "ğŸ›‘ ì´ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            docker-compose down || true
            
            # 8. ì»¨í…Œì´ë„ˆ ì‹œì‘
            echo "ğŸš€ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
            docker-compose up -d --build
            
            # 9. Health Check
            echo "ğŸ¥ Health Check ì¤‘..."
            sleep 10
            
            for i in {1..10}; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Health Check ì„±ê³µ!"
                break
              fi
              echo "   ì‹œë„ $i/10 ì‹¤íŒ¨, 5ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 5
            done
            
            # 10. ìƒíƒœ í™•ì¸
            echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker-compose ps
            
            echo "=========================================="
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "=========================================="
      
      - name: ë°°í¬ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
        if: failure()
        run: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
          echo "ì›ì¸: Docker ë¹Œë“œ ë˜ëŠ” Health Check ì‹¤íŒ¨"
