name: Docker Build & Deploy

on:
  workflow_run:
    workflows: ["CI Test (Pre-deployment)"]
    types: [completed]
    branches: [main]

# ì¤‘ë³µ ë°°í¬ ë°©ì§€ (í•œ ë²ˆì— í•˜ë‚˜ë§Œ ì‹¤í–‰)
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Docker ë¹Œë“œ & EC2 ë°°í¬
    # CI Test ì„±ê³µ ì‹œì—ë§Œ ë°°í¬
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: GitHub Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}
      
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
        working-directory: ai_server
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/onsikgu-ai-server
          IMAGE_TAG=${{ github.sha }}
          
          # ë¹Œë“œ
          docker build -t $IMAGE_NAME:$IMAGE_TAG .
          docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest
          
          # GHCRì— í‘¸ì‹œ
          docker push $IMAGE_NAME:$IMAGE_TAG
          docker push $IMAGE_NAME:latest
      
      - name: EC2 ë””ë ‰í† ë¦¬ ì¤€ë¹„ & docker-compose.yml ìƒì„±
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/onsikgu_ai
            mkdir -p /home/ubuntu/onsikgu_data/chroma
            # ì»¨í…Œì´ë„ˆ(appuser=1000)ê°€ ì“¸ ìˆ˜ ìˆë„ë¡ ê¶Œí•œ ë³´ì •
            sudo chown -R 1000:1000 /home/ubuntu/onsikgu_data/chroma || true
            
            # docker-compose.yml ìƒì„±
            cat > ~/onsikgu_ai/docker-compose.yml << 'EOF'
            services:
              ai-server:
                container_name: onsikgu-ai-server
                image: ghcr.io/${{ github.repository_owner }}/onsikgu-ai-server:latest
                ports:
                  - "8000:8000"
                volumes:
                  # NOTE: sudoë¡œ ì˜¬ë ¤ë„ ê²½ë¡œê°€ /rootë¡œ ì•ˆ ë°”ë€Œë„ë¡ ì ˆëŒ€ê²½ë¡œ ì‚¬ìš©
                  - /home/ubuntu/onsikgu_data/chroma:/data/chroma
                env_file:
                  - .env
                environment:
                  - CHROMA_PERSIST_DIRECTORY=/data/chroma
                restart: unless-stopped
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
                deploy:
                  resources:
                    limits:
                      memory: 2G
                    reservations:
                      memory: 512M
            EOF
      
      - name: EC2ì—ì„œ ì»¨í…Œì´ë„ˆ ë°°í¬
        uses: appleboy/ssh-action@master
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LANGCHAIN_API_KEY: ${{ secrets.LANGCHAIN_API_KEY }}
          LANGCHAIN_PROJECT: ${{ secrets.LANGCHAIN_PROJECT }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 10m
          envs: OPENAI_API_KEY,LANGCHAIN_API_KEY,LANGCHAIN_PROJECT
          script: |
            #!/bin/bash
            set -e
            
            echo "=========================================="
            echo "ğŸ³ Docker ë°°í¬ ì‹œì‘"
            echo "ì‹œê°„: $(date)"
            echo "=========================================="
            
            # 1. Docker ì •ë¦¬ (ë””ìŠ¤í¬ ê³µê°„ í™•ë³´)
            echo "ğŸ§¹ Docker ì •ë¦¬ ì¤‘..."
            sudo docker system prune -af --volumes || true
            echo "   âœ… ì •ë¦¬ ì™„ë£Œ"
            
            # 2. ì‘ì—… ë””ë ‰í† ë¦¬
            cd ~/onsikgu_ai
            
            # 3. GHCR ë¡œê·¸ì¸
            echo "ğŸ” GitHub Container Registry ë¡œê·¸ì¸..."
            echo "${{ secrets.GHCR_PAT }}" | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 4. ìµœì‹  ì´ë¯¸ì§€ Pull
            echo "ğŸ“¥ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            sudo docker pull ghcr.io/${{ github.repository_owner }}/onsikgu-ai-server:latest
            echo "   âœ… ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
            
            # 5. .env íŒŒì¼ ìƒì„±
            echo "ğŸ“ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¤‘..."
            cat > .env << EOF
            # OpenAI API
            OPENAI_API_KEY=${OPENAI_API_KEY}
            
            # Langsmith
            LANGCHAIN_TRACING_V2=true
            LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
            LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT}
            
            # ChromaDB
            CHROMA_PERSIST_DIRECTORY=/data/chroma
            CHROMA_COLLECTION_NAME=qa_history
            CHROMA_DATA_PATH=${HOME}/onsikgu_data/chroma
            
            # Server
            ENVIRONMENT=production
            EOF
            echo "   âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ"

            # ChromaDB ì €ì¥ ë””ë ‰í† ë¦¬ ê¶Œí•œ ë³´ì • (ì¬ë°°í¬/ì¬ê¸°ë™ ì‹œ ì¬ë°œ ë°©ì§€)
            sudo mkdir -p /home/ubuntu/onsikgu_data/chroma
            sudo chown -R 1000:1000 /home/ubuntu/onsikgu_data/chroma || true
            
            # 6. Docker ì„¤ì¹˜ í™•ì¸
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Docker ì„¤ì¹˜ ì¤‘..."
              curl -fsSL https://get.docker.com | sh
              sudo usermod -aG docker ubuntu
              newgrp docker
            fi
            
            # 7. Docker Compose ì„¤ì¹˜ í™•ì¸
            if ! command -v docker-compose &> /dev/null; then
              echo "ğŸ³ Docker Compose ì„¤ì¹˜ ì¤‘..."
              sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi
            
            # 8. ì´ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì •ë¦¬
            echo "ğŸ›‘ ì´ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            sudo docker-compose down || true
            
            # 9. ì»¨í…Œì´ë„ˆ ì‹œì‘ (ë¹Œë“œ ì—†ì´ ì´ë¯¸ì§€ ì‚¬ìš©)
            echo "ğŸš€ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
            sudo docker-compose up -d
            
            # 10. Health Check
            echo "ğŸ¥ Health Check ì¤‘..."
            sleep 10
            
            for i in {1..10}; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Health Check ì„±ê³µ!"
                break
              fi
              echo "   ì‹œë„ $i/10 ì‹¤íŒ¨, 5ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 5
            done
            
            # 11. ìƒíƒœ í™•ì¸
            echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            sudo docker-compose ps
            
            echo "=========================================="
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "=========================================="
      
      - name: ë°°í¬ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
        if: failure()
        run: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
          echo "ì›ì¸: Docker ë¹Œë“œ ë˜ëŠ” Health Check ì‹¤íŒ¨"
