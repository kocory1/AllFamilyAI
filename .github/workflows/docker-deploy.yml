name: Docker Build & Deploy

on:
  workflow_run:
    workflows: ["CI Test (Pre-deployment)"]
    types: [completed]
    branches: [main]

# ì¤‘ë³µ ë°°í¬ ë°©ì§€ (í•œ ë²ˆì— í•˜ë‚˜ë§Œ ì‹¤í–‰)
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Docker ë¹Œë“œ & EC2 ë°°í¬
    # CI Test ì„±ê³µ ì‹œì—ë§Œ ë°°í¬
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ (ai_serverë§Œ)
        working-directory: ai_server
        run: |
          docker build -t onsikgu-ai-server:${{ github.sha }} .
          docker tag onsikgu-ai-server:${{ github.sha }} onsikgu-ai-server:latest
      
      - name: Docker ì´ë¯¸ì§€ ì €ì¥ (tar)
        run: |
          docker save onsikgu-ai-server:latest | gzip > onsikgu-ai-server.tar.gz
      
      - name: EC2 ë””ë ‰í† ë¦¬ ì¤€ë¹„
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            mkdir -p ~/onsikgu_ai
            mkdir -p ~/onsikgu_data/chroma
      
      - name: Docker ì´ë¯¸ì§€ EC2ë¡œ ì „ì†¡
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "onsikgu-ai-server.tar.gz"
          target: "/home/ubuntu/onsikgu_ai/"
      
      - name: docker-compose.yml ì „ì†¡
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "ai_server/docker-compose.yml"
          target: "/home/ubuntu/onsikgu_ai/"
          strip_components: 1
      
      - name: EC2ì—ì„œ ì»¨í…Œì´ë„ˆ ë°°í¬
        uses: appleboy/ssh-action@master
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LANGCHAIN_API_KEY: ${{ secrets.LANGCHAIN_API_KEY }}
          LANGCHAIN_PROJECT: ${{ secrets.LANGCHAIN_PROJECT }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 10m
          envs: OPENAI_API_KEY,LANGCHAIN_API_KEY,LANGCHAIN_PROJECT
          script: |
            #!/bin/bash
            set -e
            
            echo "=========================================="
            echo "ğŸ³ Docker ë°°í¬ ì‹œì‘"
            echo "ì‹œê°„: $(date)"
            echo "=========================================="
            
            # 0. ê¸°ì¡´ ë ˆê±°ì‹œ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo "ğŸ§¹ ë ˆê±°ì‹œ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ ì¤‘..."
            pkill -f "uvicorn app.main:app" || true
            pkill -f "poetry install" || true
            pkill -f "poetry run" || true
            sleep 2
            echo "   âœ… ë ˆê±°ì‹œ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì™„ë£Œ"
            
            # 1. ì‘ì—… ë””ë ‰í† ë¦¬
            cd ~/onsikgu_ai
            
            # 2. Docker ì´ë¯¸ì§€ ë¡œë“œ
            echo "ğŸ“¦ Docker ì´ë¯¸ì§€ ë¡œë“œ ì¤‘..."
            gunzip -c onsikgu-ai-server.tar.gz | docker load
            rm onsikgu-ai-server.tar.gz
            echo "   âœ… ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ"
            
            # 3. ë°ì´í„° ë””ë ‰í† ë¦¬ í™•ì¸
            echo "ğŸ“‚ ë°ì´í„° ë””ë ‰í† ë¦¬ í™•ì¸ ì¤‘..."
            mkdir -p ~/onsikgu_data/chroma
            echo "   âœ… ë°ì´í„° ê²½ë¡œ: ~/onsikgu_data/chroma"
            
            # 4. .env íŒŒì¼ ìƒì„±
            echo "ğŸ“ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì¤‘..."
            cat > .env << EOF
            # OpenAI API
            OPENAI_API_KEY=${OPENAI_API_KEY}
            
            # Langsmith
            LANGCHAIN_TRACING_V2=true
            LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
            LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT}
            
            # ChromaDB
            CHROMA_PERSIST_DIRECTORY=/data/chroma
            CHROMA_COLLECTION_NAME=qa_history
            CHROMA_DATA_PATH=${HOME}/onsikgu_data/chroma
            
            # Server
            ENVIRONMENT=production
            EOF
            echo "   âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ"
            
            # 5. Docker ì„¤ì¹˜ í™•ì¸
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Docker ì„¤ì¹˜ ì¤‘..."
              curl -fsSL https://get.docker.com | sh
              sudo usermod -aG docker ubuntu
              newgrp docker
            fi
            
            # 6. Docker Compose ì„¤ì¹˜ í™•ì¸
            if ! command -v docker-compose &> /dev/null; then
              echo "ğŸ³ Docker Compose ì„¤ì¹˜ ì¤‘..."
              sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi
            
            # 7. ì´ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì •ë¦¬
            echo "ğŸ›‘ ì´ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            sudo docker-compose down || true
            
            # 8. ì»¨í…Œì´ë„ˆ ì‹œì‘ (ë¹Œë“œ ì—†ì´ ì´ë¯¸ì§€ ì‚¬ìš©)
            echo "ğŸš€ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘..."
            sudo docker-compose up -d
            
            # 9. Health Check
            echo "ğŸ¥ Health Check ì¤‘..."
            sleep 10
            
            for i in {1..10}; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Health Check ì„±ê³µ!"
                break
              fi
              echo "   ì‹œë„ $i/10 ì‹¤íŒ¨, 5ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 5
            done
            
            # 10. ìƒíƒœ í™•ì¸
            echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            sudo docker-compose ps
            
            echo "=========================================="
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "=========================================="
      
      - name: ë°°í¬ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
        if: failure()
        run: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
          echo "ì›ì¸: Docker ë¹Œë“œ ë˜ëŠ” Health Check ì‹¤íŒ¨"
