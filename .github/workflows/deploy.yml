name: Deploy to EC2

on:
  workflow_run:
    workflows: ["CI Test (Pre-deployment)"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    # CI Test ì„±ê³µ ì‹œì—ë§Œ ë°°í¬
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 120s
          debug: true
          source: ".github/scripts/*"
          target: "~/"
          strip_components: 2

      - name: EC2 ë°°í¬ ì‹¤í–‰ (í¬ê·¸ë¼ìš´ë“œ)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 600s  # 10ë¶„ (Health Check í¬í•¨)
          debug: true
          script: |
            chmod +x ~/deploy.sh
            ~/deploy.sh "${{ secrets.OPENAI_API_KEY }}" "${{ secrets.LANGCHAIN_API_KEY }}" "${{ secrets.LANGCHAIN_PROJECT }}"
            # & ì œê±°: í¬ê·¸ë¼ìš´ë“œ ì‹¤í–‰, exit code ì „ë‹¬
            # deploy.sh ë‚´ë¶€ì˜ Health Check ê²°ê³¼ê°€ GitHub Actionsì— ë°˜ì˜ë¨

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          echo "ğŸš€ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“ ì„œë²„: http://3.38.113.60"
          echo "ğŸ“ Health: http://3.38.113.60/health"
          echo "ğŸ“š API ë¬¸ì„œ: http://3.38.113.60/docs"
          echo ""
          echo "âœ… Health Check ì„±ê³µ í™•ì¸ë¨"
      
      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
          echo "ì›ì¸: deploy.sh ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (Health Check ì‹¤íŒ¨ ê°€ëŠ¥)"
          echo "ë¡œê·¸ í™•ì¸: ssh ubuntu@${{ secrets.EC2_HOST }} 'tail -100 ~/onsikgu_ai/ai_server/server.log'"
          exit 1
